# StreamCFI

### STREAMCFI: Streamed Per-Input Control-Flow Integrity

_We present the implementation of StreamCFI, a novel approach to Control-Flow
Integrity (CFI) that enforces a combined forward-edge type-based and
per-input CFI policy. StreamCFI is built on top of the SideCar framework
and it's implemntation of decoupled CFI, SideCFI._

## Project Structure

```bash
.
├── README.md                    # Project overview and instructions
├── docs                         # Documentation files
│   ├── llvm-changes.diff        # Diff results between LLVM 12.0.1 and SideCar LLVM
│   └── llvm-modifications.md    # Modifications to LLVM 12.0.1 for SideCar
├── sidecar-driver               # Kernel drivers for different architectures
│   └── x86-64                   # Drivers for x86-64 architecture
├── sidecar-examples             # Example implementations using StreamCFI
│   └── streamcfi                # Example with StreamCFI enabled
├── sidecar-llvm                 # Modified LLVM source and related tools
├── sidecar-monitors             # Monitors for StreamCFI components
│   └── streamcfi                # Monitor for StreamCFI
└── tools                        # Scripts and tools for setup and experiments
    ├── gen_tp.sh                # Generate typemaps for StreamCFI/StreamCFI
    └── install.sh               # LLVM installation script
```

## Installation

### StreamCFI Linux Kernel Driver (SideCar Driver)

##### x86-64

To build and install the StreamCFI Linux kernel driver on Intel, run the following commands:

```bash
cd sidecar-driver/x86-64
make
sudo insmod ptw.ko
```

##### Aarch64

If cross-compiling the StreamCFI Linux kernel driver for ARM, the environment variables `CROSS_COMPILE` and `KERNELDIR` need to be set like below:

```bash
export CROSS_COMPILE=/path/to/toolchain/bin/aarch64-linux-gnu-
export KERNELDIR=/path/to/kernel
```

To build run the following commands:

```bash
cd sidecar-driver/aarch64
make
```

To install run the following (after moving driver to ARM device in case of cross-compilation):

```bash
sudo insmod cs_driver.ko
```

### StreamCFI LLVM Toolchain (SideCar LLVM)

To build and install the StreamCFI LLVM toolchain, ensure that the following dependencies are installed:

```bash
sudo apt-get install zlib1g-dev binutils-dev binutils-gold build-essential cmake ninja-build
```

Once the dependencies are installed, run the following commands:

```bash
./tools/install.sh llvm-sidecar
```

This will create a `build` directory in the root of the repository for build files and an `install` directory for the installation of the LLVM toolchain.

### StreamCFI Monitor

The StreamCFI monitor can be built by moving to the respective directory and running `make`.
e.g. for the x86-64 StreamCFI monitor:

```bash
cd sidecar-monitors/sidecfi/x86-64
make
```

## Usage

Use the custom clang binary located at `install/llvm-sidecar/bin/clang` for compilation.

### SideCFI / StreamCFI

Multiple flags control the CFI instrumentation:

1.  **Base CFI Flags (Required for all CFI variants):**

    - `-flto`: Enable Link Time Optimization.
    - `-fsanitize=cfi-icall,cfi-vcall`: Enable LLVM's base indirect call and virtual call checks.
    - `-fsanitize-cfi-cross-dso`: Enable cross-DSO CFI checks.

2.  **Decoupled CFI (SideCFI - using `LowerTypeTests` pass):**

    - `-fsanitize-cfi-decouple`: Decouples _all_ CFI checks (both fast and slow paths) using `ptwrite` messages generated by the `LowerTypeTests` pass.
    - `-fsanitize-cfi-slowpath-decouple`: Decouples _only the slow path_ CFI checks using `ptwrite` messages generated by the `LowerTypeTests` pass.

3.  **StreamCFI (using `Sidectx` pass):**

    - `-fsanitize-cfi-streamcfi`: Enables the StreamCFI mechanism. This activates the `Sidectx` pass, which instruments function activations (entries) and indirect calls with `ptwrite` messages. _Note: This flag is independent of the `-fsanitize-cfi-decouple` flags._

4.  **Payload Size Control:**

    - `-fsanitize-cfi-ptwrite64`: Switches the `ptwrite` payload size from the default 32 bits (containing hashed type IDs or partial addresses) to 64 bits (containing full type IDs or addresses). This flag affects _both_ Decoupled CFI (`-fsanitize-cfi-decouple`/`-fsanitize-cfi-slowpath-decouple`) and StreamCFI (`-fsanitize-cfi-streamcfi`).

5.  **32-bit Address Space Optimization (Avoiding Hashing):**
    - When using 32-bit `ptwrite` payloads, to avoid hash collisions and send direct addresses/IDs, the application's address space (including all its libraries) can be constrained. We achieve this by pinning the binary and its libraries to addresses below 2GB (effectively using 31 bits for addressing). This leaves 1 bit for an opcode in the 32-bit `ptwrite` payload.
    - This address space reduction is performed using [libshrink](https://github.com/vusec/libshrink), which prelinks the binary and its dependencies to low addresses and uses `LD_PRELOAD` to manage the address space at runtime. Refer to the `libshrink` project for details on its usage.
    - Example: `./wrap.sh /path/to/binary_built_with_streamcfi_llvm`

**Common Scenarios:**

- **Original SideCFI (Decoupled Checks, 32-bit payload):**
  ```bash
  clang ... -flto -fsanitize=cfi-icall,cfi-vcall -fsanitize-cfi-cross-dso -fsanitize-cfi-decouple
  ```
- **Original SideCFI (Decoupled Checks, 64-bit payload):**
  ```bash
  clang ... -flto -fsanitize=cfi-icall,cfi-vcall -fsanitize-cfi-cross-dso -fsanitize-cfi-decouple -fsanitize-cfi-ptwrite64
  ```
- **StreamCFI (Activation/ICall Checks, 32-bit payload):**
  ```bash
  clang ... -flto -fsanitize=cfi-icall,cfi-vcall -fsanitize-cfi-cross-dso -fsanitize-cfi-streamcfi
  ```
- **StreamCFI (Activation/ICall Checks, 64-bit payload):**
  ```bash
  clang ... -flto -fsanitize=cfi-icall,cfi-vcall -fsanitize-cfi-cross-dso -fsanitize-cfi-streamcfi -fsanitize-cfi-ptwrite64
  ```

**Typemap Requirement:**
The StreamCFI monitor currently requires a typemap file containing metadata about the compiled binary's symbols. This can be produced by executing the script:

```bash
./tools/gen_tp.sh <path/to/compiled/binary>
```

### Decoupling from Sanitizer Common Runtime

To minimize binary bloat and avoid dependencies on LLVM's `sanitizer_common` runtime, StreamCFI's custom runtimes (`clang_rt.dcfi` and `clang_rt.sidecar`) have been refactored.

**The Issue:** Initially, our `dcfi` runtime, which is responsible for enabling Intel PT via an ioctl to the kernel driver, relied on `sanitizer_common` for its initialization (e.g., using `.preinit_array` constructs) and utility functions. Compiling applications with `-fno-sanitize-common` (to avoid linking `sanitizer_common`) would prevent this crucial PT-enabling code from running.

**The Solution:**
The `dcfi` and `sidecar` runtimes were modified to:

- Use `__attribute__((constructor(0)))` for early initialization of `__dcfi_init` instead of sanitizer-specific preinitializers.
- Replace sanitizer utility functions (e.g., `Printf`, `Die`) with standard C library equivalents (e.g., `fprintf`, `exit`).
- Implement `dlopen`/`dlclose` interception using `dlsym(RTLD_NEXT, ...)` and `pthread_once` instead of sanitizer interceptor macros.
- Their `CMakeLists.txt` files were updated to remove dependencies on `SANITIZER_COMMON_CFLAGS` and sanitizer object libraries.

As a result of these changes, applications using StreamCFI should be compiled and linked with the following additional flags to ensure the custom runtimes are correctly linked and initialized:

```bash
# Example application link command additions:
# (Actual library paths may vary based on your installation)
-Wl,--whole-archive /path/to/your/install/libclang_rt.dcfi-ARCH.a -Wl,--no-whole-archive \
/path/to/your/install/libclang_rt.sidecar-ARCH.a \
-lpthread -ldl
```

The flag `-fno-sanitize-link-runtime` can also be used during compilation and linking to prevent the compiler driver from automatically linking other standard sanitizer runtimes if they are not desired. The combination of the refactored runtimes and these explicit linker arguments ensures that PT is enabled and `dlopen`/`dlclose` are intercepted without pulling in the bulk of `sanitizer_common`.

## Example

Example programs built with StreamCFI can be found in the `sidecar-examples/streamcfi` directory. Entering the directory and running `make` will compile the example using the appropriate flags as described in the **Usage** section.

e.g. for SideCFI/StreamCFI:

```bash
cd sidecar-examples/sideccfi
make
```
